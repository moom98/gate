name: Auto-fix from ALL PR Feedback (Gemini) - Debounced

on:
  pull_request_review_comment:
    types: [created, edited]
  pull_request_review:
    types: [submitted, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-autofix-pr-${{ github.repository }}-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  autofix:
    # ループ＆無駄実行を避ける + Jules由来のものはスキップ
    if: >
      github.actor != 'github-actions[bot]' &&
      github.actor != 'gemini-cli[bot]' &&
      github.actor != 'google-labs-jules[bot]' &&
      (
        github.event_name != 'issue_comment' ||
        (
          github.event.issue.pull_request &&
          !contains(github.event.comment.body, '[gemini-autofix]') &&
          !contains(github.event.comment.body, 'google-labs-jules') &&
          !contains(github.event.comment.body, '[jules]') &&
          !contains(github.event.comment.body, 'Jules')
        )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      # Wait time (seconds) before processing to batch bursts of feedback.
      DEBOUNCE_SECONDS: "300"

    steps:
      - name: Debounce (wait for more comments)
        shell: bash
        run: |
          echo "Debouncing for ${DEBOUNCE_SECONDS}s..."
          sleep "${DEBOUNCE_SECONDS}"

      - name: Gather PR + all feedback (reviews / inline / issue comments)
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const eventName = context.eventName;
            const payload = context.payload;

            let prNumber;
            let triggerSource = eventName;
            let triggerBody = "";

            if (eventName === "pull_request_review_comment") {
              prNumber = payload.pull_request.number;
              triggerBody = payload.comment?.body || "";
            } else if (eventName === "pull_request_review") {
              prNumber = payload.pull_request.number;
              triggerBody = payload.review?.body || "";
            } else if (eventName === "issue_comment") {
              prNumber = payload.issue.number;
              triggerBody = payload.comment?.body || "";
              if (!payload.issue.pull_request) {
                core.setFailed("issue_comment is not on a PR.");
                return;
              }
            } else {
              core.setFailed(`Unsupported event: ${eventName}`);
              return;
            }

            const pr = (await github.rest.pulls.get({
              owner, repo, pull_number: prNumber
            })).data;

            const reviewComments = await github.paginate(
              github.rest.pulls.listReviewComments,
              { owner, repo, pull_number: prNumber, per_page: 100 }
            );

            const reviews = await github.paginate(
              github.rest.pulls.listReviews,
              { owner, repo, pull_number: prNumber, per_page: 100 }
            );

            const issueComments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: prNumber, per_page: 100 }
            );

            const fmt = (s) => (s || "").trim();
            const MAX_ITEMS = 60; // Keep prompt size manageable while retaining recent context
            const toBase64 = (str) => Buffer.from(str || "", "utf8").toString("base64");

            const trimmedReviewComments = reviewComments.slice(-MAX_ITEMS);
            const trimmedReviews = reviews.slice(-MAX_ITEMS);
            const trimmedIssueComments = issueComments
              .filter(c => {
                const body = fmt(c.body);
                if (!body) return false;
                // 自分の結果コメントを除外
                if (body.includes("[gemini-autofix]")) return false;
                // julesっぽいコメントは除外（保険）
                if (body.includes("google-labs-jules") || body.includes("[jules]") || body.includes("Jules")) return false;
                return true;
              })
              .slice(-MAX_ITEMS);

            const reviewCommentsBlock = trimmedReviewComments.map(c => {
              const loc = [
                c.path ? `file: ${c.path}` : null,
                (c.original_line || c.line) ? `line: ${c.original_line || c.line}` : null
              ].filter(Boolean).join(", ");
              return [
                `- [review_comment] ${c.user?.login || "unknown"} (${loc})`,
                `  url: ${c.html_url}`,
                `  body: |`,
                ...fmt(c.body).split("\n").map(l => `    ${l}`)
              ].join("\n");
            }).join("\n\n");

            const reviewsBlock = trimmedReviews
              .filter(r => fmt(r.body).length > 0)
              .map(r => {
                return [
                  `- [review] ${r.user?.login || "unknown"} state: ${r.state}`,
                  `  url: ${r.html_url}`,
                  `  body: |`,
                  ...fmt(r.body).split("\n").map(l => `    ${l}`)
                ].join("\n");
              }).join("\n\n");

            const issueCommentsBlock = trimmedIssueComments
              .map(c => {
                return [
                  `- [issue_comment] ${c.user?.login || "unknown"}`,
                  `  url: ${c.html_url}`,
                  `  body: |`,
                  ...fmt(c.body).split("\n").map(l => `    ${l}`)
                ].join("\n");
              }).join("\n\n");

            core.setOutput("pr_number", String(prNumber));
            core.setOutput("pr_title", pr.title || "");
            core.setOutput("pr_url", pr.html_url || "");
            core.setOutput("head_ref", pr.head.ref);

            core.setOutput("trigger_source", triggerSource);
            core.setOutput("trigger_body", triggerBody);

            core.setOutput("review_comments_block", reviewCommentsBlock || "(none)");
            core.setOutput("reviews_block", reviewsBlock || "(none)");
            core.setOutput("issue_comments_block", issueCommentsBlock || "(none)");

            core.setOutput("trigger_body_b64", toBase64(triggerBody));
            core.setOutput("review_comments_block_b64", toBase64(reviewCommentsBlock));
            core.setOutput("reviews_block_b64", toBase64(reviewsBlock));
            core.setOutput("issue_comments_block_b64", toBase64(issueCommentsBlock));

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Set up Node (optional)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build prompt
        id: prompt
        shell: bash
        run: |
          trigger_body=$(echo "${{ steps.pr.outputs.trigger_body_b64 }}" | base64 --decode || printf '')
          review_comments=$(echo "${{ steps.pr.outputs.review_comments_block_b64 }}" | base64 --decode || printf '(none)')
          reviews_block=$(echo "${{ steps.pr.outputs.reviews_block_b64 }}" | base64 --decode || printf '(none)')
          issue_comments=$(echo "${{ steps.pr.outputs.issue_comments_block_b64 }}" | base64 --decode || printf '(none)')

          cat > /tmp/gemini_prompt.txt <<'EOF'
          あなたはリポジトリ内で動作する自動修正エージェントです。
          目的: このPRに付いている「レビュー指摘 / PRコメント指摘」を満たすように、必要最小限の変更で修正してください。

          制約:
          - 無関係なリファクタは禁止（指摘対応に必要な範囲のみ）
          - 既存の設計・命名・コーディング規約を尊重
          - 変更はローカルファイルに反映し、コミット可能な状態にする
          - 競合する指摘があれば、その理由をPRコメントに短く説明する

          対象PR:
          - URL: ${{ steps.pr.outputs.pr_url }}
          - タイトル: ${{ steps.pr.outputs.pr_title }}
          - ブランチ: ${{ steps.pr.outputs.head_ref }}

          今回のトリガー:
          - source: ${{ steps.pr.outputs.trigger_source }}
          - body:
          ---
          ${trigger_body}
          ---

          直近のレビューコメント（inline）:
          ---
          ${review_comments}
          ---

          直近のレビュー本文（Approve/Request changes 等）:
          ---
          ${reviews_block}
          ---

          PR会話欄のコメント（issue_comment）:
          ---
          ${issue_comments}
          ---

          最後に、実施内容を日本語で箇条書き（3〜8行）でまとめてください。
          EOF

          echo "prompt<<__PROMPT__" >> "$GITHUB_OUTPUT"
          cat /tmp/gemini_prompt.txt >> "$GITHUB_OUTPUT"
          echo "__PROMPT__" >> "$GITHUB_OUTPUT"

      - name: Run Gemini CLI (apply fixes)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.18
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: ${{ steps.prompt.outputs.prompt }}
          gemini_cli_version: 0.5.0

      - name: Commit & push changes (if any)
        id: commit
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "gemini-cli[bot]"
          git config user.email "gemini-cli[bot]@users.noreply.github.com"

          git add -A
          SUMMARY="${{ steps.gemini.outputs.summary }}"
          git commit -m "chore: gemini autofix for PR #${{ steps.pr.outputs.pr_number }}" -m "${SUMMARY:-Auto-fix from Gemini}"

          TARGET_BRANCH="${{ steps.pr.outputs.head_ref }}"
          if [[ -z "$TARGET_BRANCH" ]]; then
            echo "Error: target branch empty" >&2
            exit 1
          fi

          if ! git push origin "HEAD:$TARGET_BRANCH"; then
            echo "Error: failed to push changes to origin/$TARGET_BRANCH" >&2
            exit 1
          fi

          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Comment result back to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = Number("${{ steps.pr.outputs.pr_number }}");

            const changed = "${{ steps.commit.outputs.changed }}";
            const sha = "${{ steps.commit.outputs.sha }}";
            const summary = `${{ steps.gemini.outputs.summary }}`.trim();
            const err = `${{ steps.gemini.outputs.error }}`.trim();

            let body = [
              "### [gemini-autofix] 対応結果",
              `- changed: **${changed}**`,
              sha ? `- commit: \`${sha}\`` : `- commit: (no changes)`,
              "",
              "#### summary",
              summary || "(no summary)",
            ].join("\n");

            if (err) {
              body += `\n\n#### error\n\`\`\`\n${err}\n\`\`\`\n`;
            }

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: prNumber,
              body
            });
